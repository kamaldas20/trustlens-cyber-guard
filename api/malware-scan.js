import crypto from "crypto";

export const config = {
  api: {
    bodyParser: false
  }
};

export default async function handler(req, res) {
  try {
    const file = req.body;

    const buffer = Buffer.from(await req.arrayBuffer());

    // generate SHA256 hash
    const hash = crypto.createHash("sha256").update(buffer).digest("hex");

    const VT_KEY = process.env.VIRUSTOTAL_API_KEY;

    // check hash in VirusTotal
    const response = await fetch(
      `https://www.virustotal.com/api/v3/files/${hash}`,
      {
        headers: {
          "x-apikey": VT_KEY
        }
      }
    );

    const data = await response.json();

    const stats = data?.data?.attributes?.last_analysis_stats;

    const malicious = stats?.malicious || 0;

    res.json({
      hash,
      malicious,
      verdict: malicious > 0 ? "malware" : "clean"
    });

  } catch (err) {
    res.status(500).json({ error: "Malware scan failed" });
  }
}